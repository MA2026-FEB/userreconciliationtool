<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>URT - Universal Reconciliation Tool</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .content {
            padding: 40px;
        }

        .step {
            margin-bottom: 40px;
        }

        .step-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }

        .step-number {
            width: 40px;
            height: 40px;
            background: #667eea;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2em;
            margin-right: 15px;
        }

        .step-title {
            font-size: 1.5em;
            color: #333;
        }

        .provider-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .provider-card {
            background: #f8f9fa;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .provider-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.3);
            border-color: #667eea;
        }

        .provider-card.selected {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
        }

        .provider-card h3 {
            font-size: 1.3em;
            margin-bottom: 10px;
        }

        .provider-card p {
            font-size: 0.9em;
            opacity: 0.8;
        }

        .date-input-group {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
        }

        .date-input-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 10px;
            color: #333;
        }

        .date-input-group input {
            width: 100%;
            max-width: 300px;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 1em;
        }

        .file-upload-area {
            background: #f8f9fa;
            border: 2px dashed #667eea;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .file-upload-area:hover {
            background: #e8ebff;
            border-color: #764ba2;
        }

        .file-upload-area.dragover {
            background: #e8ebff;
            border-color: #764ba2;
        }

        .file-upload-area input[type="file"] {
            display: none;
        }

        .upload-label {
            cursor: pointer;
            color: #667eea;
            font-weight: 600;
            font-size: 1.1em;
        }

        .file-list {
            margin-top: 20px;
        }

        .file-item {
            background: white;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .file-item button {
            background: #ff4444;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 1.1em;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .results-container {
            display: none;
            margin-top: 40px;
        }

        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .results-table th,
        .results-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        .results-table th {
            background: #667eea;
            color: white;
            font-weight: 600;
        }

        .results-table tr:hover {
            background: #f8f9fa;
        }

        .status-match {
            color: #10b981;
            font-weight: 600;
        }

        .status-investigate {
            color: #ef4444;
            font-weight: 600;
        }

        .missing-holding {
            color: #ef4444;
        }

        .alert {
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
        }

        .alert-info {
            background: #e8f4fd;
            color: #0066cc;
            border-left: 4px solid #0066cc;
        }

        .alert-warning {
            background: #fff4e6;
            color: #cc6600;
            border-left: 4px solid #cc6600;
        }

        .alert-success {
            background: #e6f7ed;
            color: #008844;
            border-left: 4px solid #008844;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            opacity: 0.9;
        }

        .download-btn {
            background: #10b981;
            margin-right: 10px;
        }

        .download-btn:hover {
            background: #059669;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîÑ Universal Reconciliation Tool</h1>
            <p>Portfolio Holdings Reconciliation - v3.00</p>
        </div>

        <div class="content">
            <!-- Step 1: Select Provider -->
            <div class="step" id="step1">
                <div class="step-header">
                    <div class="step-number">1</div>
                    <div class="step-title">Select Provider</div>
                </div>
                <div class="provider-grid">
                    <div class="provider-card" data-provider="advisernet">
                        <h3>AdviserNet</h3>
                        <p>PDF to CSV conversion</p>
                    </div>
                    <div class="provider-card" data-provider="centric">
                        <h3>Centric</h3>
                        <p>LoadDocstore report</p>
                    </div>
                    <div class="provider-card" data-provider="cfsedge">
                        <h3>CFS Edge</h3>
                        <p>Holdings-Valuation</p>
                    </div>
                    <div class="provider-card" data-provider="fnzsec">
                        <h3>FNZ Securities</h3>
                        <p>HoldingsStatement</p>
                    </div>
                    <div class="provider-card" data-provider="panorama">
                        <h3>BT Panorama</h3>
                        <p>Portfolio Valuation CSV</p>
                    </div>
                </div>
            </div>

            <!-- Step 2: Enter PV Reporting Date -->
            <div class="step" id="step2" style="display: none;">
                <div class="step-header">
                    <div class="step-number">2</div>
                    <div class="step-title">Enter Reporting Date</div>
                </div>
                <div class="alert alert-info">
                    <strong>Reminder:</strong> The Provider and Xplan PV reports must be generated on the same date.
                </div>
                <div class="date-input-group">
                    <label for="pvDate">PV Reporting Date:</label>
                    <input type="date" id="pvDate" required>
                </div>
            </div>

            <!-- Step 3: Upload Files -->
            <div class="step" id="step3" style="display: none;">
                <div class="step-header">
                    <div class="step-number">3</div>
                    <div class="step-title">Upload Files</div>
                </div>
                <div class="alert alert-info" id="uploadInstructions">
                    Upload your files here
                </div>
                
                <div class="file-upload-area" id="dropZone">
                    <input type="file" id="fileInput" multiple accept=".csv,.pdf">
                    <label for="fileInput" class="upload-label">
                        üìÅ Click to browse or drag files here
                    </label>
                    <p style="margin-top: 10px; color: #666;">Accepted formats: CSV, PDF</p>
                </div>

                <div class="file-list" id="fileList"></div>

                <button class="btn" id="processBtn" disabled onclick="processFiles()">
                    Process Reconciliation
                </button>
            </div>

            <!-- Loading Indicator -->
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>Processing reconciliation...</p>
            </div>

            <!-- Results -->
            <div class="results-container" id="results">
                <div class="step-header">
                    <div class="step-number">‚úì</div>
                    <div class="step-title">Reconciliation Results</div>
                </div>

                <div class="alert alert-success" id="completionMessage"></div>

                <div class="stats-grid" id="statsGrid"></div>

                <div style="margin-bottom: 20px;">
                    <button class="btn download-btn" onclick="downloadExcel()">
                        üì• Download Excel Report
                    </button>
                    <button class="btn" onclick="resetTool()">
                        üîÑ Start New Reconciliation
                    </button>
                </div>

                <div class="alert alert-warning">
                    <strong>Note:</strong> Term Deposits and unsettled/pending amounts may require further review.
                </div>

                <table class="results-table" id="resultsTable">
                    <thead>
                        <tr>
                            <th>Provider Code</th>
                            <th>Provider Units</th>
                            <th>Xplan Code</th>
                            <th>Xplan Units</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="resultsBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        let selectedProvider = null;
        let uploadedFiles = [];
        let reconciliationData = [];
        let startTime = 0;
        let parsedFileData = []; // Store parsed file data for Excel export

        // Provider selection
        document.querySelectorAll('.provider-card').forEach(card => {
            card.addEventListener('click', function() {
                document.querySelectorAll('.provider-card').forEach(c => c.classList.remove('selected'));
                this.classList.add('selected');
                selectedProvider = this.dataset.provider;
                
                // Show step 2
                document.getElementById('step2').style.display = 'block';
                
                // Update upload instructions
                updateUploadInstructions();
            });
        });

        // Date input validation
        document.getElementById('pvDate').addEventListener('change', function() {
            if (this.value) {
                document.getElementById('step3').style.display = 'block';
            }
        });

        // File upload handling
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');

        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('dragover');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            handleFiles(e.dataTransfer.files);
        });

        fileInput.addEventListener('change', (e) => {
            handleFiles(e.target.files);
        });

        function updateUploadInstructions() {
            const instructions = {
                'advisernet': 'Upload: (1) PDF AdviserNet PV (optional), (2) Xplan PV (portfolio_position_holdings), (3) Converted AdviserNet CSV',
                'centric': 'Upload: (1) Xplan PV (portfolio_position_holdings), (2) Centric PV (LoadDocstore)',
                'cfsedge': 'Upload: (1) Xplan PV (portfolio_position_holdings), (2) CFS Edge PV (Holdings-Valuation)',
                'fnzsec': 'Upload: (1) Xplan PV (portfolio_position_holdings), (2) FNZ PV (HoldingsStatement)',
                'panorama': 'Upload: (1) Xplan PV (portfolio_position_holdings), (2) BT Panorama PV (portfolioValuationCsvReport)'
            };
            
            document.getElementById('uploadInstructions').innerHTML = 
                `<strong>Required files:</strong> ${instructions[selectedProvider]}`;
        }

        function handleFiles(files) {
            uploadedFiles = Array.from(files);
            displayFileList();
            document.getElementById('processBtn').disabled = uploadedFiles.length < 2;
        }

        function displayFileList() {
            const fileList = document.getElementById('fileList');
            fileList.innerHTML = '';
            
            uploadedFiles.forEach((file, index) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.innerHTML = `
                    <span>${file.name} (${(file.size / 1024).toFixed(2)} KB)</span>
                    <button onclick="removeFile(${index})">Remove</button>
                `;
                fileList.appendChild(fileItem);
            });
        }

        function removeFile(index) {
            uploadedFiles.splice(index, 1);
            displayFileList();
            document.getElementById('processBtn').disabled = uploadedFiles.length < 2;
        }

        function processFiles() {
            startTime = Date.now();
            document.getElementById('loading').style.display = 'block';
            parsedFileData = [];
            
            // Parse all uploaded CSV files
            let filesProcessed = 0;
            uploadedFiles.forEach((file, index) => {
                if (file.name.toLowerCase().endsWith('.csv')) {
                    Papa.parse(file, {
                        complete: function(results) {
                            parsedFileData.push({
                                name: file.name.replace('.csv', ''),
                                data: results.data
                            });
                            filesProcessed++;
                            
                            if (filesProcessed === uploadedFiles.filter(f => f.name.toLowerCase().endsWith('.csv')).length) {
                                performReconciliation();
                            }
                        },
                        error: function(error) {
                            console.error('Error parsing file:', error);
                            filesProcessed++;
                        }
                    });
                } else {
                    // For non-CSV files (like PDFs), just note them
                    parsedFileData.push({
                        name: file.name,
                        data: [['File type not supported for preview', file.name]]
                    });
                    filesProcessed++;
                }
            });
            
            // Fallback in case no CSV files
            if (uploadedFiles.filter(f => f.name.toLowerCase().endsWith('.csv')).length === 0) {
                setTimeout(() => {
                    performReconciliation();
                }, 1000);
            }
        }

        function performReconciliation() {
            // Parse the actual CSV data to perform real reconciliation
            let xplanData = null;
            let providerData = null;
            
            // Identify which file is which based on naming patterns
            parsedFileData.forEach(file => {
                const fileName = file.name.toLowerCase();
                if (fileName.includes('portfolio_position') || fileName.includes('xplan')) {
                    xplanData = file.data;
                } else if (fileName.includes('loaddocstore') || fileName.includes('centric') ||
                           fileName.includes('holdings') || fileName.includes('valuation') ||
                           fileName.includes('panorama') || fileName.includes('advisernet')) {
                    providerData = file.data;
                }
            });
            
            if (!xplanData || !providerData) {
                // Fallback to sample data if files can't be parsed
                const sampleData = generateSampleData();
                reconciliationData = sampleData;
                displayResults(sampleData);
                return;
            }
            
            // Perform actual reconciliation based on provider type
            const results = reconcileData(xplanData, providerData);
            reconciliationData = results;
            displayResults(results);
        }
        
        function reconcileData(xplanData, providerData) {
            const results = [];
            
            console.log('=== RECONCILIATION DEBUG ===');
            console.log('Provider Data rows:', providerData.length);
            console.log('Xplan Data rows:', xplanData.length);
            console.log('Selected Provider:', selectedProvider);
            
            // Parse provider data (skip header row)
            const providerHoldings = new Map();
            console.log('\n=== PARSING PROVIDER DATA ===');
            for (let i = 1; i < providerData.length; i++) {
                const row = providerData[i];
                if (!row || row.length < 2) continue; // Skip empty rows
                
                let code = '';
                let units = 0;
                
                // Handle provider-specific formatting
                if (selectedProvider === 'centric') {
                    // LoadDocstore: Column C = Investment Code (index 2), Column E = Quantity (index 4)
                    code = row[2]; // Column C - Investment Code
                    
                    // Parse units - remove commas and convert to number
                    let unitsStr = row[4];
                    if (typeof unitsStr === 'string') {
                        unitsStr = unitsStr.replace(/,/g, ''); // Remove commas
                    }
                    units = parseFloat(unitsStr) || 0;
                    
                    // Clean the code - remove .AU and .XASX suffixes and normalize case
                    if (code) {
                        code = code.replace('.AU', '').replace('.XASX', '').toUpperCase();
                    }
                    
                    if (i <= 5) { // Log first 5 rows for debugging
                        console.log(`Row ${i}: Full row =`, row);
                        console.log(`  -> Raw Code (index 2): "${row[2]}", Cleaned: "${code}", Raw Units: "${row[4]}", Parsed: ${units}`);
                    }
                } else if (selectedProvider === 'cfsedge') {
                    code = row[1]; // Code column
                    units = parseFloat(row[2]) || 0; // Units column
                } else if (selectedProvider === 'panorama') {
                    code = row[2]; // Code column  
                    units = parseFloat(row[12]) || 0; // Units column
                } else if (selectedProvider === 'fnzsec') {
                    code = row[0]; // Code column
                    units = parseFloat(row[2]) || 0; // Units column
                } else if (selectedProvider === 'advisernet') {
                    code = row[1]; // Code column
                    units = parseFloat(row[2]) || 0; // Units column
                }
                
                if (!code) continue;
                
                if (providerHoldings.has(code)) {
                    providerHoldings.set(code, providerHoldings.get(code) + units);
                } else {
                    providerHoldings.set(code, units);
                }
            }
            
            console.log('\nProvider Holdings Map:', providerHoldings);
            
            // Parse Xplan data (skip header row)
            const xplanHoldings = new Map();
            console.log('\n=== PARSING XPLAN DATA ===');
            for (let i = 1; i < xplanData.length; i++) {
                const row = xplanData[i];
                if (!row || row.length < 32) continue; // Skip empty/invalid rows
                
                // Column AF (index 31) = Security Code
                // Column K (index 10) = Units
                let code = row[31]; // AF column - Security Code
                
                // Parse units - remove commas and convert to number
                let unitsStr = row[10];
                if (typeof unitsStr === 'string') {
                    unitsStr = unitsStr.replace(/,/g, ''); // Remove commas
                }
                let units = parseFloat(unitsStr) || 0; // K column - Units
                
                if (i <= 5) { // Log first 5 rows for debugging
                    console.log(`Row ${i}: Code (index 31): "${code}", Raw Units: "${row[10]}", Parsed: ${units}`);
                }
                
                if (!code) continue;
                
                if (xplanHoldings.has(code)) {
                    xplanHoldings.set(code, xplanHoldings.get(code) + units);
                } else {
                    xplanHoldings.set(code, units);
                }
            }
            
            console.log('\nXplan Holdings Map:', xplanHoldings);
            
            // Reconcile: Start with all unique codes
            const allCodes = new Set([...providerHoldings.keys(), ...xplanHoldings.keys()]);
            console.log('\n=== ALL UNIQUE CODES ===');
            console.log('Codes:', Array.from(allCodes));
            
            allCodes.forEach(code => {
                const providerUnits = providerHoldings.get(code);
                const xplanUnits = xplanHoldings.get(code);
                
                let providerCode = code;
                let providerUnitsDisplay = providerUnits;
                let xplanCode = code;
                let xplanUnitsDisplay = xplanUnits;
                let status = 'MATCH';
                
                // Handle missing holdings
                if (providerUnits !== undefined && xplanUnits === undefined) {
                    // Present in provider, missing in Xplan
                    xplanCode = 'Missing Holding';
                    xplanUnitsDisplay = 'Missing Units';
                    status = 'INVESTIGATE';
                } else if (providerUnits === undefined && xplanUnits !== undefined) {
                    // Missing in provider, present in Xplan
                    providerCode = 'Missing Holding';
                    providerUnitsDisplay = 'Missing Units';
                    status = 'INVESTIGATE';
                } else if (providerUnits !== undefined && xplanUnits !== undefined) {
                    // Both present - check if units match
                    if (Math.abs(providerUnits - xplanUnits) >= 0.01) {
                        status = 'INVESTIGATE';
                    }
                }
                
                results.push({
                    providerCode: providerCode,
                    providerUnits: providerUnitsDisplay,
                    xplanCode: xplanCode,
                    xplanUnits: xplanUnitsDisplay,
                    status: status
                });
            });
            
            console.log('\n=== FINAL RESULTS ===');
            results.forEach((r, idx) => {
                console.log(`${idx + 1}. ${r.providerCode} (${r.providerUnits}) vs ${r.xplanCode} (${r.xplanUnits}) = ${r.status}`);
            });
            
            // Sort results: INVESTIGATEs first, then MATCHes
            results.sort((a, b) => {
                if (a.status === 'INVESTIGATE' && b.status !== 'INVESTIGATE') return -1;
                if (a.status !== 'INVESTIGATE' && b.status === 'INVESTIGATE') return 1;
                return 0;
            });
            
            return results;
        }

        function displayResults(data) {
            const processingTime = ((Date.now() - startTime) / 1000).toFixed(2);
            
            document.getElementById('loading').style.display = 'none';
            document.getElementById('results').style.display = 'block';
            
            // Completion message
            document.getElementById('completionMessage').innerHTML = 
                `<strong>Success!</strong> Reconciliation completed in ${processingTime} seconds.`;
            
            // Statistics
            const matches = data.filter(d => d.status === 'MATCH').length;
            const investigations = data.filter(d => d.status === 'INVESTIGATE').length;
            
            document.getElementById('statsGrid').innerHTML = `
                <div class="stat-card">
                    <div class="stat-value">${data.length}</div>
                    <div class="stat-label">Total Holdings</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${matches}</div>
                    <div class="stat-label">Matches</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${investigations}</div>
                    <div class="stat-label">To Investigate</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${processingTime}s</div>
                    <div class="stat-label">Processing Time</div>
                </div>
            `;
            
            // Results table
            const tbody = document.getElementById('resultsBody');
            tbody.innerHTML = '';
            
            data.forEach(row => {
                const tr = document.createElement('tr');
                
                const providerCodeClass = row.providerCode === 'Missing Holding' ? 'missing-holding' : '';
                const xplanCodeClass = row.xplanCode === 'Missing Holding' ? 'missing-holding' : '';
                
                // Format units - only format numbers, keep text as-is
                const providerUnits = (typeof row.providerUnits === 'number') ? 
                    row.providerUnits.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 2}) : 
                    (row.providerUnits || 'Missing Units');
                    
                const xplanUnits = (typeof row.xplanUnits === 'number') ? 
                    row.xplanUnits.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 2}) : 
                    (row.xplanUnits || 'Missing Units');
                
                tr.innerHTML = `
                    <td class="${providerCodeClass}">${row.providerCode}</td>
                    <td class="${providerCodeClass}">${providerUnits}</td>
                    <td class="${xplanCodeClass}">${row.xplanCode}</td>
                    <td class="${xplanCodeClass}">${xplanUnits}</td>
                    <td class="${row.status === 'MATCH' ? 'status-match' : 'status-investigate'}">${row.status}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function downloadExcel() {
            // Create a new workbook
            const wb = XLSX.utils.book_new();
            
            // Sheet 1: Holding Reconcile (Main Results)
            const reconcileData = [
                ['Provider Code', 'Provider Units', 'Xplan Code', 'Xplan Units', 'Verification Status']
            ];
            reconciliationData.forEach(row => {
                reconcileData.push([
                    row.providerCode,
                    row.providerUnits,
                    row.xplanCode,
                    row.xplanUnits,
                    row.status
                ]);
            });
            const ws1 = XLSX.utils.aoa_to_sheet(reconcileData);
            XLSX.utils.book_append_sheet(wb, ws1, 'Holding Reconcile');
            
            // Sheet 2: Audit Information
            const pvDate = document.getElementById('pvDate').value;
            const processingTime = ((Date.now() - startTime) / 1000).toFixed(2);
            const matches = reconciliationData.filter(d => d.status === 'MATCH').length;
            const investigations = reconciliationData.filter(d => d.status === 'INVESTIGATE').length;
            
            const auditData = [
                ['Metric', 'Value'],
                ['Provider', selectedProvider.charAt(0).toUpperCase() + selectedProvider.slice(1)],
                ['PV Reporting Date', pvDate],
                ['Date Generated', new Date().toLocaleString()],
                ['Processing Time (seconds)', processingTime],
                ['Total Holdings Reconciled', reconciliationData.length],
                ['Matches', matches],
                ['Investigations Required', investigations],
                ['URT Version', 'v3.00 Web'],
                ['Files Processed', uploadedFiles.length]
            ];
            const ws2 = XLSX.utils.aoa_to_sheet(auditData);
            XLSX.utils.book_append_sheet(wb, ws2, 'Audit');
            
            // Add original uploaded files as separate sheets
            parsedFileData.forEach((fileData, index) => {
                try {
                    // Clean sheet name (Excel has 31 char limit and special char restrictions)
                    let sheetName = fileData.name
                        .replace(/[:\\\/\?\*\[\]]/g, '_') // Remove invalid chars
                        .substring(0, 31); // Max 31 chars
                    
                    // Ensure unique sheet name
                    let finalSheetName = sheetName;
                    let counter = 1;
                    while (wb.SheetNames.includes(finalSheetName)) {
                        finalSheetName = sheetName.substring(0, 28) + '_' + counter;
                        counter++;
                    }
                    
                    const ws = XLSX.utils.aoa_to_sheet(fileData.data);
                    XLSX.utils.book_append_sheet(wb, ws, finalSheetName);
                } catch (error) {
                    console.error('Error adding sheet:', error);
                }
            });
            
            // Generate filename with timestamp
            const timestamp = new Date().toISOString().split('T')[0].replace(/-/g, '');
            const filename = `URT_${selectedProvider}_${timestamp}.xlsx`;
            
            // Download the file
            XLSX.writeFile(wb, filename);
            
            // Show success message
            alert(`Excel workbook exported successfully!\n\nSheets included:\n- Holding Reconcile (Results)\n- Audit (Statistics)\n${parsedFileData.map(f => '- ' + f.name).join('\n')}`);
        }

        function resetTool() {
            location.reload();
        }
    </script>
</body>
</html>